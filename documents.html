<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management - Angkor Compliance Platform</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Modern CSS -->
    <link rel="stylesheet" href="assets/css/main-modern.css">
    <link rel="stylesheet" href="assets/css/super-admin-navigation.css">
    
    <!-- Inter Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Navigation System -->
    <script src="assets/js/navigation-config.js"></script>
    <script src="assets/js/navigation-template.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module" src="firebase-config.js"></script>
    
    <!-- OpenAI Integration -->
    <script src="assets/js/openai-integration.js"></script>

    <style>
        .documents-layout {
            display: flex;
            min-height: 100vh;
            background: var(--neutral-50);
        }
        
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--neutral-200);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-decoration: none;
            color: var(--neutral-900);
        }
        
        .sidebar-nav {
            flex: 1;
            padding: var(--space-4) 0;
            overflow-y: auto;
        }
        
        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-6);
            text-decoration: none;
            color: var(--neutral-700);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .sidebar-nav-item:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }
        
        .sidebar-nav-item.active {
            background: var(--primary-50);
            color: var(--primary-700);
            border-right: 3px solid var(--primary-500);
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
        }
        
        .page-header {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: white;
            padding: var(--space-8) var(--space-8);
            border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .page-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
            position: relative;
            z-index: 1;
        }
        
        .page-title h1 {
            font-size: var(--text-4xl);
            font-weight: 800;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .page-title h1 i {
            width: 32px;
            height: 32px;
        }
        
        .page-title p {
            color: rgba(255, 255, 255, 0.9);
            font-size: var(--text-lg);
            margin: var(--space-2) 0 0 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-3);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--primary-600);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--neutral-100);
            color: var(--neutral-700);
            border: 1px solid var(--neutral-200);
        }
        
        .btn-secondary:hover {
            background: var(--neutral-200);
        }
        
        .btn-white {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-white:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            position: relative;
            z-index: 1;
        }
        
        .quick-stat {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .quick-stat:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .quick-stat-value {
            font-size: var(--text-2xl);
            font-weight: 800;
            color: white;
            margin-bottom: var(--space-1);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .quick-stat-label {
            font-size: var(--text-sm);
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }
        
        .filters-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .filter-label {
            font-weight: 500;
            color: var(--neutral-700);
            font-size: 0.875rem;
        }
        
        .filter-input,
        .filter-select {
            padding: var(--space-3);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }
        
        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .search-input {
            position: relative;
        }
        
        .search-input input {
            padding-left: 2.5rem;
        }
        
        .search-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--neutral-400);
        }
        
        .documents-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
            overflow: hidden;
        }
        
        .documents-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .view-toggle {
            display: flex;
            background: var(--neutral-100);
            border-radius: var(--radius-md);
            padding: var(--space-1);
        }
        
        .view-option {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--neutral-600);
        }
        
        .view-option.active {
            background: white;
            color: var(--neutral-900);
            box-shadow: var(--shadow-sm);
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-4);
            padding: var(--space-6);
        }
        
        .document-card {
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .document-card:hover {
            border-color: var(--primary-300);
            background: var(--primary-25);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .document-header {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .document-icon {
            width: 40px;
            height: 40px;
            color: var(--primary-600);
            flex-shrink: 0;
        }
        
        .document-info {
            flex: 1;
            min-width: 0;
        }
        
        .document-title {
            font-weight: 600;
            color: var(--neutral-900);
            margin-bottom: var(--space-1);
            word-break: break-word;
        }
        
        .document-category {
            font-size: 0.75rem;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .document-meta {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.875rem;
            color: var(--neutral-600);
        }
        
        .document-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-badge.active {
            background: var(--success-100);
            color: var(--success-700);
        }
        
        .status-badge.expiring {
            background: var(--warning-100);
            color: var(--warning-700);
        }
        
        .status-badge.expired {
            background: var(--danger-100);
            color: var(--danger-700);
        }
        
        .document-actions {
            display: flex;
            gap: var(--space-1);
        }
        
        .action-btn {
            padding: var(--space-1);
            border: none;
            background: transparent;
            color: var(--neutral-500);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: var(--neutral-100);
            color: var(--neutral-700);
        }
        
        .documents-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .documents-table th {
            background: var(--neutral-50);
            padding: var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--neutral-700);
            font-size: 0.875rem;
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .documents-table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--neutral-100);
            vertical-align: middle;
        }
        
        .documents-table tr:hover {
            background: var(--neutral-25);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-12);
            color: var(--neutral-600);
        }
        
        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            color: var(--neutral-400);
        }
        
        .loading-state {
            text-align: center;
            padding: var(--space-8);
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--neutral-300);
            border-top: 3px solid var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: var(--space-4);
            left: var(--space-4);
            z-index: 1001;
            background: var(--primary-600);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            width: 44px;
            height: 44px;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }
        
        .mobile-overlay.open {
            display: block;
        }
        
        /* Enhanced Features */
        .document-card.selected {
            border-color: var(--primary-500);
            background: var(--primary-25);
            box-shadow: var(--shadow-md);
        }
        
        .document-checkbox {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            z-index: 10;
        }
        
        .document-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-600);
        }
        
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary-500);
        }
        
        .toast-notification.toast-success {
            border-left-color: var(--success-500);
        }
        
        .toast-notification.toast-error {
            border-left-color: var(--danger-500);
        }
        
        .toast-notification.toast-warning {
            border-left-color: var(--warning-500);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .toast-notification.show {
            transform: translateX(0);
        }
        
        .document-preview-modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            z-index: 2001;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--neutral-600);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }
        
        .modal-body {
            padding: var(--space-6);
        }
        
        /* Toast Notifications */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary-500);
        }
        
        .toast-notification.show {
            transform: translateX(0);
        }
        
        .toast-notification.toast-success {
            border-left-color: var(--success-500);
        }
        
        .toast-notification.toast-error {
            border-left-color: var(--danger-500);
        }
        
        .toast-notification.toast-warning {
            border-left-color: var(--warning-500);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            z-index: 2001;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--neutral-600);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--neutral-100);
            color: var(--neutral-900);
        }
        
        .modal-body {
            padding: var(--space-6);
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }
        
        .import-preview {
            margin-bottom: var(--space-6);
        }
        
        .import-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            #bulkActions {
                flex-direction: column;
                gap: var(--space-2);
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: var(--space-4);
            }
            
            .page-header {
                padding: var(--space-4);
            }
            
            .header-content {
                flex-direction: column;
                gap: var(--space-4);
                align-items: flex-start;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
            }
            
            .documents-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        
        /* AI Analysis Styles */
        .ai-analysis-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .ai-analysis-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }
        
        .ai-analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .ai-analysis-modal .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .ai-analysis-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .ai-analysis-modal .modal-header h3 {
            margin: 0;
            color: var(--neutral-900);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .ai-analysis-modal .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--neutral-500);
            padding: 4px;
            border-radius: 4px;
        }
        
        .ai-analysis-modal .close-btn:hover {
            background: var(--neutral-100);
            color: var(--neutral-700);
        }
        
        .ai-analysis-modal .modal-body {
            padding: 24px;
        }
        
        .document-info {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .document-info h4 {
            margin: 0 0 8px 0;
            color: var(--neutral-900);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .document-meta {
            color: var(--neutral-600);
            font-size: 0.875rem;
        }
        
        .analysis-results {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .analysis-section {
            background: var(--neutral-50);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--neutral-200);
        }
        
        .analysis-section h5 {
            margin: 0 0 12px 0;
            color: var(--neutral-900);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .status-badge, .risk-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.compliant {
            background: var(--success-100);
            color: var(--success-700);
        }
        
        .status-badge.non-compliant {
            background: var(--danger-100);
            color: var(--danger-700);
        }
        
        .status-badge.needs-review {
            background: var(--warning-100);
            color: var(--warning-700);
        }
        
        .risk-badge.low {
            background: var(--success-100);
            color: var(--success-700);
        }
        
        .risk-badge.medium {
            background: var(--warning-100);
            color: var(--warning-700);
        }
        
        .risk-badge.high {
            background: var(--danger-100);
            color: var(--danger-700);
        }
        
        .score-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .score-bar {
            flex: 1;
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-500) 0%, var(--warning-500) 50%, var(--success-500) 100%);
            transition: width 0.3s ease;
        }
        
        .score-text {
            font-weight: 600;
            color: var(--neutral-700);
            min-width: 60px;
        }
        
        .issues-list, .recommendations-list, .priority-actions {
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: 6px;
            padding: 12px;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--neutral-700);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--neutral-200);
        }
        
        @media (max-width: 768px) {
            .ai-analysis-modal .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .ai-analysis-modal .modal-header,
            .ai-analysis-modal .modal-body {
                padding: 16px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="documents-layout">
        <!-- Navigation will be loaded dynamically -->
        <div id="sidebarContainer"></div>
        <script>
        // Load sidebar template and initialize navigation
        fetch('assets/html/sidebar-template.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('sidebarContainer').innerHTML = html;
                // Navigation will auto-initialize via navigation-template.js
            })
            .catch(error => console.error('Error loading sidebar template:', error));
        </script>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="page-title">
                    <div>
                        <h1><i data-lucide="file-text"></i> Document Management</h1>
                        <p>Manage your compliance documents and permits</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-outline btn-white" onclick="exportDocuments()">
                            <i data-lucide="download"></i>
                            Export Data
                        </button>
                        <button class="btn btn-outline btn-white" onclick="importDocuments()">
                            <i data-lucide="upload"></i>
                            Import Data
                        </button>
                        <a href="upload.html" class="btn btn-primary" id="uploadDocumentsBtn">
                            <i data-lucide="plus"></i>
                            Upload Documents
                        </a>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="totalDocuments">-</div>
                        <div class="quick-stat-label">Total Documents</div>
                        </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="expiringSoon">-</div>
                        <div class="quick-stat-label">Expiring Soon</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="expiredDocuments">-</div>
                        <div class="quick-stat-label">Expired</div>
                </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="thisMonthUploads">-</div>
                        <div class="quick-stat-label">This Month</div>
                        </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="totalSize">-</div>
                        <div class="quick-stat-label">Total Size</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="complianceScore">-</div>
                        <div class="quick-stat-label">Compliance Score</div>
                </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="pendingReview">-</div>
                        <div class="quick-stat-label">Pending Review</div>
                        </div>
                    </div>
            </header>
            
            <!-- Filters Section -->
            <section class="filters-section" style="margin: var(--space-6);">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Search Documents</label>
                        <div class="search-input">
                            <i data-lucide="search" class="search-icon"></i>
                            <input type="text" id="searchInput" class="filter-input" placeholder="Search by title, category, or document number...">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Category</label>
                        <select id="categoryFilter" class="filter-select">
                            <option value="">All Categories</option>
                            <option value="business-license">Business License</option>
                            <option value="safety-certificate">Safety Certificate</option>
                            <option value="environmental-permit">Environmental Permit</option>
                            <option value="labor-compliance">Labor Compliance</option>
                            <option value="quality-certificate">Quality Certificate</option>
                            <option value="insurance-policy">Insurance Policy</option>
                            <option value="audit-report">Audit Report</option>
                            <option value="training-record">Training Record</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Factory</label>
                        <select id="factoryFilter" class="filter-select">
                            <option value="">All Factories</option>
                            <!-- Factories will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Upload Date</label>
                        <select id="dateFilter" class="filter-select">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">File Type</label>
                        <select id="typeFilter" class="filter-select">
                            <option value="">All Types</option>
                            <option value="application/pdf">PDF</option>
                            <option value="application/msword">Word Document</option>
                            <option value="image/jpeg">Image (JPEG)</option>
                            <option value="image/png">Image (PNG)</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-secondary" onclick="clearAllFilters()">
                        <i data-lucide="x"></i>
                        Clear Filters
                    </button>
                    <span id="resultsCount" class="text-sm text-neutral-600">Loading documents...</span>
                </div>
            </section>
            
            <!-- Documents Section -->
            <section class="documents-section">
                <div class="documents-header">
                    <h2 class="font-semibold text-neutral-900">Documents</h2>
                    <div style="display: flex; align-items: center; gap: var(--space-4);">
                        <!-- Bulk Actions -->
                        <div id="bulkActions" style="display: none; align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-4); background: var(--primary-50); border-radius: var(--radius-md); border: 1px solid var(--primary-200);">
                            <!-- Bulk actions will be populated here -->
                        </div>
                        
                        <div class="view-toggle">
                            <button class="view-option active" data-view="grid" onclick="setView('grid')">
                                <i data-lucide="grid-3x3"></i>
                            </button>
                            <button class="view-option" data-view="list" onclick="setView('list')">
                                <i data-lucide="list"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="documentsContainer">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading documents...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase and Auth Scripts -->
    <script src="assets/js/lang.js"></script>
    <script src="assets/js/auth.js"></script>
    <script type="module">
    
    // Enhanced Document Management
    (function() {
        // Enhanced Document Management with Real-time Updates
        let allDocuments = [];
        let filteredDocuments = [];
        let factories = [];
        let currentView = 'grid';
        let selectedDocuments = new Set();
        let realTimeListeners = [];
        let currentUserRole = null;
        let currentUserFactoryId = null;
        let canWrite = false;
        let auth, db, doc, getDoc, collection, query, orderBy, where, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, serverTimestamp, EmailAuthProvider, getDocs;
        
        // Initialize Firebase
        async function initializeFirebase() {
            try {
                // Check if Firebase is available
                if (window.Firebase) {
                    auth = window.Firebase.auth;
                    db = window.Firebase.db;
                    
                    // Load Firebase functions from the global Firebase object
                    doc = window.Firebase.doc;
                    getDoc = window.Firebase.getDoc;
                    collection = window.Firebase.collection;
                    query = window.Firebase.query;
                    orderBy = window.Firebase.orderBy;
                    where = window.Firebase.where;
                    onSnapshot = window.Firebase.onSnapshot;
                    addDoc = window.Firebase.addDoc;
                    updateDoc = window.Firebase.updateDoc;
                    deleteDoc = window.Firebase.deleteDoc;
                    writeBatch = window.Firebase.writeBatch;
                    serverTimestamp = window.Firebase.serverTimestamp;
                    EmailAuthProvider = window.Firebase.EmailAuthProvider;
                    getDocs = window.Firebase.getDocs;
                    
                    console.log('✅ Firebase instances and functions loaded successfully');
                    return true;
                } else {
                    console.log('⚠️ Firebase not available, using local mode');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error initializing Firebase:', error);
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Enhanced Document Management loading... (v3.0 - Firebase v10+ compatible)');
            
            // Initialize Firebase first
            const firebaseReady = await initializeFirebase();
            if (!firebaseReady) {
                console.log('⚠️ Firebase not ready, loading sample data');
                loadSampleDocuments();
                return;
            }
            
            await checkAuthentication();
            if (!canWrite) {
                const uploadBtn = document.querySelector('.header-actions a.btn.btn-primary');
                if (uploadBtn) uploadBtn.style.display = 'none';
            }
            await initializePage();
            setupEventListeners();
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            console.log('✅ Enhanced Document Management loaded');
        });
        
        async function checkAuthentication() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async function(user) {
                    if (!user) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    try {
                        const userDocRef = doc(db, 'users', user.uid);
                        const userDoc = await getDoc(userDocRef);
                        
                        if (!userDoc.exists()) {
                            window.location.href = 'login.html';
                            return;
                        }
                        
                        const userData = userDoc.data();
                        currentUserRole = userData.role;
                        currentUserFactoryId = userData.factoryId || null;
                        canWrite = (userData.role === 'super_admin' || userData.role === 'factory_admin');
                        
                        if (!['super_admin', 'factory_admin', 'hr_staff', 'auditor'].includes(userData.role)) {
                            window.location.href = 'dashboard.html';
                            return;
                        }
                        
                        console.log('✅ Access granted for:', userData.role);
                        resolve();
                        
                    } catch (error) {
                        console.error('❌ Auth error:', error);
                        window.location.href = 'login.html';
                    }
                });
            });
        }
        
        async function initializePage() {
            try {
                await Promise.all([
                    loadFactories(),
                    loadDocuments()
                ]);
                
                updateDocumentsDisplay();
                
                // Only update stats if the page is fully loaded
                if (document.readyState === 'complete') {
                    updateStats();
                } else {
                    // Wait for the page to be fully loaded
                    window.addEventListener('load', updateStats);
                }
                
                setupRealTimeListeners();
                
                // Initialize bulk actions
                updateBulkActions();
                
            } catch (error) {
                console.error('❌ Error initializing page:', error);
                showError('Failed to load document data. Please refresh the page.');
            }
        }
        
        function setupRealTimeListeners() {
            try {
                let documentsRef = collection(db, 'documents');
                let q;
                
                if ((currentUserRole === 'factory_admin' || currentUserRole === 'hr_staff') && currentUserFactoryId) {
                    q = query(documentsRef, where('factoryId', '==', currentUserFactoryId));
                } else {
                    q = query(documentsRef);
                }
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            handleDocumentAdded(change.doc);
                        } else if (change.type === 'modified') {
                            handleDocumentModified(change.doc);
                        } else if (change.type === 'removed') {
                            handleDocumentRemoved(change.doc.id);
                        }
                    });
                });
                
                realTimeListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
            }
        }
        
        async function loadFactories() {
            try {
                const factoriesRef = collection(db, 'factories');
                const snapshot = await getDocs(factoriesRef);
                factories = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('✅ Factories loaded:', factories.length);

                // Populate factory filter options
                const factorySelect = document.getElementById('factoryFilter');
                if (factorySelect) {
                    const current = factorySelect.value || '';
                    factorySelect.innerHTML = '<option value="">All Factories</option>';
                    factories.forEach(factory => {
                        const option = document.createElement('option');
                        option.value = factory.id;
                        option.textContent = factory.name || factory.id;
                        factorySelect.appendChild(option);
                    });
                    if (current) {
                        factorySelect.value = current;
                    }
                }
            } catch (error) {
                console.error('❌ Error loading factories:', error);
                factories = [];
                // Load sample factories if Firebase fails
                loadSampleFactories();
            }
        }
        
        async function loadDocuments() {
            try {
                console.log('📄 Loading documents...');
                
                // Set a timeout to prevent infinite loading
                const loadingTimeout = setTimeout(() => {
                    console.log('⏰ Loading timeout reached, using sample data');
                    loadSampleDocuments();
                }, 10000); // 10 seconds timeout
                
                let documentsRef = collection(db, 'documents');
                let q;
                
                if ((currentUserRole === 'factory_admin' || currentUserRole === 'hr_staff') && currentUserFactoryId) {
                    try {
                        q = query(documentsRef, where('factoryId', '==', currentUserFactoryId), orderBy('uploadedAt', 'desc'));
                    } catch (error) {
                        console.log('⚠️ Cannot order by uploadedAt, using simple query');
                        q = query(documentsRef, where('factoryId', '==', currentUserFactoryId));
                    }
                } else {
                    try {
                        q = query(documentsRef, orderBy('uploadedAt', 'desc'));
                    } catch (error) {
                        console.log('⚠️ Cannot order by uploadedAt, using simple query');
                        q = query(documentsRef);
                    }
                }
                
                const snapshot = await getDocs(q);
                
                allDocuments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort by uploadedAt desc if present
                allDocuments.sort((a, b) => {
                    const ad = a.uploadedAt && typeof a.uploadedAt.toDate === 'function' ? a.uploadedAt.toDate() : (a.uploadedAt ? new Date(a.uploadedAt) : new Date(0));
                    const bd = b.uploadedAt && typeof b.uploadedAt.toDate === 'function' ? b.uploadedAt.toDate() : (b.uploadedAt ? new Date(b.uploadedAt) : new Date(0));
                    return bd - ad;
                });
                filteredDocuments = [...allDocuments];
                console.log('✅ Documents loaded:', allDocuments.length);
                
                // Clear the timeout since we loaded successfully
                clearTimeout(loadingTimeout);
                
            } catch (error) {
                console.error('❌ Error loading documents:', error);
                console.log('⚠️ Using sample documents due to Firebase error');
                clearTimeout(loadingTimeout);
                loadSampleDocuments();
            }
        }
        
        function loadSampleDocuments() {
            console.log('📋 Loading sample documents for demonstration...');
            
            // Sample documents data
            allDocuments = [
                {
                    id: 'doc-001',
                    title: 'Business License 2024',
                    originalName: 'business_license_2024.pdf',
                    category: 'business-license',
                    status: 'active',
                    factoryId: 'factory-001',
                    uploadedAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // 30 days ago
                    expirationDate: new Date(Date.now() + 335 * 24 * 60 * 60 * 1000), // 335 days from now
                    documentNumber: 'BL-2024-001',
                    issuingAuthority: 'Ministry of Commerce',
                    fileSize: 245760, // 240 KB
                    fileType: 'application/pdf'
                },
                {
                    id: 'doc-002',
                    title: 'Safety Certificate',
                    originalName: 'safety_certificate.pdf',
                    category: 'safety-certificate',
                    status: 'active',
                    factoryId: 'factory-002',
                    uploadedAt: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000), // 15 days ago
                    expirationDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000), // 180 days from now
                    documentNumber: 'SC-2024-002',
                    issuingAuthority: 'Ministry of Labor',
                    fileSize: 512000, // 500 KB
                    fileType: 'application/pdf'
                },
                {
                    id: 'doc-003',
                    title: 'Environmental Permit',
                    originalName: 'environmental_permit.pdf',
                    category: 'environmental-permit',
                    status: 'expired',
                    factoryId: 'factory-001',
                    uploadedAt: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000), // 60 days ago
                    expirationDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                    documentNumber: 'EP-2023-003',
                    issuingAuthority: 'Ministry of Environment',
                    fileSize: 1024000, // 1 MB
                    fileType: 'application/pdf'
                }
            ];
            
            filteredDocuments = [...allDocuments];
            
            console.log('✅ Sample documents loaded:', allDocuments.length);
        }
        
        function loadSampleFactories() {
            console.log('🏢 Loading sample factories for demonstration...');
            
            // Sample factories data
            factories = [
                {
                    id: 'factory-001',
                    name: 'Angkor Textile Factory',
                    location: 'Phnom Penh',
                    industry: 'Textile'
                },
                {
                    id: 'factory-002',
                    name: 'Siem Reap Garment Co.',
                    location: 'Siem Reap',
                    industry: 'Garment'
                },
                {
                    id: 'factory-003',
                    name: 'Battambang Manufacturing',
                    location: 'Battambang',
                    industry: 'Manufacturing'
                }
            ];
            
            // Populate factory filter options
            const factorySelect = document.getElementById('factoryFilter');
            if (factorySelect) {
                factorySelect.innerHTML = '<option value="">All Factories</option>';
                factories.forEach(factory => {
                    const option = document.createElement('option');
                    option.value = factory.id;
                    option.textContent = factory.name || factory.id;
                    factorySelect.appendChild(option);
                });
            }
            
            console.log('✅ Sample factories loaded:', factories.length);
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const factoryFilter = document.getElementById('factoryFilter')?.value || '';
            const dateFilter = document.getElementById('dateFilter')?.value || '';
            const typeFilter = document.getElementById('typeFilter')?.value || '';
            
            filteredDocuments = allDocuments.filter(doc => {
                // Search filter
                const searchMatch = !searchTerm || 
                    doc.title?.toLowerCase().includes(searchTerm) ||
                    doc.originalName?.toLowerCase().includes(searchTerm) ||
                    doc.description?.toLowerCase().includes(searchTerm) ||
                    doc.documentNumber?.toLowerCase().includes(searchTerm) ||
                    doc.issuingAuthority?.toLowerCase().includes(searchTerm);
                
                // Category filter
                const categoryMatch = !categoryFilter || doc.category === categoryFilter;
                
                // Status filter
                const status = getDocumentStatus(doc);
                const statusMatch = !statusFilter || status === statusFilter;
                
                // Factory filter
                const factoryMatch = !factoryFilter || doc.factoryId === factoryFilter;
                
                // Date filter
                let dateMatch = true;
                if (dateFilter) {
                    const docDate = safeToDate(doc.uploadedAt);
                    if (!(docDate instanceof Date) || isNaN(docDate.getTime())) {
                        dateMatch = false;
                    } else {
                        const now = new Date();
                        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        if (dateFilter === 'today') {
                            dateMatch = docDate >= startOfToday;
                        } else if (dateFilter === 'week') {
                            const startOfWeek = new Date(startOfToday);
                            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                            dateMatch = docDate >= startOfWeek;
                        } else if (dateFilter === 'month') {
                            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                            dateMatch = docDate >= startOfMonth;
                        } else if (dateFilter === 'quarter') {
                            const currentQuarter = Math.floor(now.getMonth() / 3);
                            const startMonth = currentQuarter * 3;
                            const startOfQuarter = new Date(now.getFullYear(), startMonth, 1);
                            dateMatch = docDate >= startOfQuarter;
                        } else {
                            dateMatch = true;
                        }
                    }
                }
                
                // Type filter
                const typeMatch = !typeFilter || doc.fileType?.includes(typeFilter);
                
                return searchMatch && categoryMatch && statusMatch && factoryMatch && dateMatch && typeMatch;
            });
            
            updateDocumentsDisplay();
            updateStats();
            updateResultsCount();
        }
        
        function updateDocumentsDisplay() {
            const container = document.getElementById('documentsContainer');
            if (!container) return;
            
            if (filteredDocuments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i data-lucide="file-text"></i>
                        </div>
                        <h3>No documents found</h3>
                        <p>Try adjusting your search or filters to find what you're looking for.</p>
                        <button class="btn btn-primary" onclick="clearAllFilters()">
                            <i data-lucide="refresh-cw"></i>
                            Clear Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            if (currentView === 'grid') {
                container.innerHTML = filteredDocuments.map(doc => createDocumentCard(doc)).join('');
            } else {
                container.innerHTML = createDocumentsTable(filteredDocuments);
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Re-apply selection state after re-render
            try {
                selectedDocuments.forEach((id) => {
                    const cb = container.querySelector(`input[type="checkbox"][data-doc-id="${id}"]`);
                    if (cb) cb.checked = true;
                });
            } catch (e) {}

            // Update results count text
            updateResultsCount();
        }

        function updateResultsCount() {
            const results = document.getElementById('resultsCount');
            if (!results) return;
            const count = filteredDocuments.length;
            const total = allDocuments.length;
            results.textContent = total > 0 && count !== total
                ? `Showing ${count} of ${total} documents`
                : `Showing ${count} documents`;
        }
        
        function createDocumentCard(doc) {
            const status = getDocumentStatus(doc);
            const statusClass = status === 'expired' ? 'expired' : status === 'expiring' ? 'expiring' : 'active';
            
            return `
                <div class="document-card" onclick="viewDocument('${doc.id}')">
                    <div class="document-checkbox">
                        <input type="checkbox" data-doc-id="${doc.id}" onclick="event.stopPropagation()" onchange="toggleDocumentSelection('${doc.id}')">
                    </div>
                    <div class="document-icon">
                        ${getDocumentIcon(doc.fileType)}
                    </div>
                    <div class="document-info">
                        <h4>${doc.title || doc.originalName || 'Untitled Document'}</h4>
                        <p class="document-category">${doc.categoryName || 'Uncategorized'}</p>
                        <p class="document-factory">${doc.factoryId || 'Unknown Factory'}</p>
                        <div class="document-meta">
                            <span class="document-size">${formatFileSize(doc.fileSize)}</span>
                            <span class="document-date">${formatDate(doc.uploadedAt)}</span>
                        </div>
                        <div class="document-status ${statusClass}">
                            ${getStatusIcon(status)} ${formatStatus(status)}
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); downloadDocument('${doc.id}')" title="Download">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); shareDocument('${doc.id}')" title="Share">
                            <i data-lucide="share-2" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="action-btn ai-analysis-btn" onclick="event.stopPropagation(); analyzeDocumentWithAI('${doc.id}')" title="AI Analysis">
                            <i data-lucide="brain" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); editDocument('${doc.id}')" title="Edit">
                            <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); viewVersions('${doc.id}')" title="Versions">
                            <i data-lucide="git-branch" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createDocumentsTable(documents) {
            return `
                <table class="documents-table">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="selectAllDocuments()">
                            </th>
                            <th>Document</th>
                            <th>Category</th>
                            <th>Factory</th>
                            <th>Status</th>
                            <th>Upload Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documents.map(doc => createDocumentRow(doc)).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function createDocumentRow(doc) {
            const status = getDocumentStatus(doc);
            const statusClass = status === 'expired' ? 'expired' : status === 'expiring' ? 'expiring' : 'active';
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="document-checkbox" data-doc-id="${doc.id}" onchange="toggleDocumentSelection('${doc.id}')">
                    </td>
                    <td>
                        <div class="document-info-cell">
                            <div class="document-icon">
                                ${getDocumentIcon(doc.fileType)}
                            </div>
                            <div>
                                <h4>${doc.title || doc.originalName || 'Untitled Document'}</h4>
                                <p>${formatFileSize(doc.fileSize)} • ${doc.fileType || 'Unknown type'}</p>
                            </div>
                        </div>
                    </td>
                    <td>${doc.categoryName || 'Uncategorized'}</td>
                    <td>${doc.factoryId || 'Unknown Factory'}</td>
                    <td>
                        <span class="document-status ${statusClass}">
                            ${getStatusIcon(status)} ${formatStatus(status)}
                        </span>
                    </td>
                    <td>${formatDate(doc.uploadedAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="downloadDocument('${doc.id}')" title="Download">
                                <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="action-btn" onclick="shareDocument('${doc.id}')" title="Share">
                                <i data-lucide="share-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="action-btn ai-analysis-btn" onclick="analyzeDocumentWithAI('${doc.id}')" title="AI Analysis">
                                <i data-lucide="brain" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="action-btn" onclick="editDocument('${doc.id}')" title="Edit">
                                <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="action-btn" onclick="viewVersions('${doc.id}')" title="Versions">
                                <i data-lucide="git-branch" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function updateStats() {
            const totalDocs = allDocuments.length;
            const expiringDocs = allDocuments.filter(doc => getDocumentStatus(doc) === 'expiring').length;
            const expiredDocs = allDocuments.filter(doc => getDocumentStatus(doc) === 'expired').length;
            
            const thisMonth = new Date();
            thisMonth.setDate(1);
            thisMonth.setHours(0, 0, 0, 0);
            
            const thisMonthDocs = allDocuments.filter(doc => {
                let docDate = doc.uploadedAt;
                
                // Handle Firestore Timestamp objects
                if (docDate && typeof docDate.toDate === 'function') {
                    docDate = docDate.toDate();
                } else if (typeof docDate === 'string') {
                    docDate = new Date(docDate);
                } else if (typeof docDate === 'number') {
                    docDate = new Date(docDate);
                }
                
                // Ensure we have a valid Date object
                if (!(docDate instanceof Date) || isNaN(docDate.getTime())) {
                    return false;
                }
                
                return docDate >= thisMonth;
            }).length;
            
            // Calculate total file size
            const totalSize = allDocuments.reduce((sum, doc) => sum + (doc.fileSize || 0), 0);
            const totalSizeFormatted = formatFileSize(totalSize);
            
            // Calculate compliance score (based on document status)
            const compliantDocs = allDocuments.filter(doc => getDocumentStatus(doc) === 'valid').length;
            const complianceScore = totalDocs > 0 ? Math.round((compliantDocs / totalDocs) * 100) : 0;
            
            // Calculate pending review documents
            const pendingReview = allDocuments.filter(doc => doc.status === 'pending' || doc.status === 'review').length;
            
            const totalDocsElement = document.getElementById('totalDocuments');
            const expiringDocsElement = document.getElementById('expiringSoon');
            const expiredDocsElement = document.getElementById('expiredDocuments');
            const thisMonthElement = document.getElementById('thisMonthUploads');
            const totalSizeElement = document.getElementById('totalSize');
            const complianceScoreElement = document.getElementById('complianceScore');
            const pendingReviewElement = document.getElementById('pendingReview');
            
            if (totalDocsElement) totalDocsElement.textContent = totalDocs;
            if (expiringDocsElement) expiringDocsElement.textContent = expiringDocs;
            if (expiredDocsElement) expiredDocsElement.textContent = expiredDocs;
            if (thisMonthElement) thisMonthElement.textContent = thisMonthDocs;
            if (totalSizeElement) totalSizeElement.textContent = totalSizeFormatted;
            if (complianceScoreElement) complianceScoreElement.textContent = complianceScore + '%';
            if (pendingReviewElement) pendingReviewElement.textContent = pendingReview;
        }
        
        function handleDocumentAdded(doc) {
            const data = doc.data();
            const newDoc = { id: doc.id, ...data };
            
            // Add to allDocuments if not already present
            if (!allDocuments.find(d => d.id === doc.id)) {
                allDocuments.unshift(newDoc);
                applyFilters();
            }
        }
        
        function handleDocumentModified(doc) {
            const data = doc.data();
            const updatedDoc = { id: doc.id, ...data };
            
            // Update in allDocuments
            const index = allDocuments.findIndex(d => d.id === doc.id);
            if (index !== -1) {
                allDocuments[index] = updatedDoc;
                applyFilters();
            }
        }
        
        function handleDocumentRemoved(docId) {
            // Remove from allDocuments
            allDocuments = allDocuments.filter(d => d.id !== docId);
            applyFilters();
            updateStats();
        }
        
        function setupEventListeners() {
            // Enhanced search with debouncing
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        applyFilters();
                    }, 300);
                });
            }
            
            // Filter changes
            ['categoryFilter', 'statusFilter', 'factoryFilter', 'dateFilter', 'typeFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'f':
                            e.preventDefault();
                            document.getElementById('searchInput')?.focus();
                            break;
                        case 'n':
                            e.preventDefault();
                            window.location.href = 'upload.html';
                            break;
                        case 'a':
                            e.preventDefault();
                            selectAllDocuments();
                            break;
                    }
                }
            });
        }
        
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border: 1px solid var(--neutral-200);
                border-radius: var(--radius-lg);
                padding: var(--space-4);
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
                border-left: 4px solid ${type === 'success' ? 'var(--success-500)' : type === 'error' ? 'var(--danger-500)' : 'var(--primary-500)'};
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}" style="width: 16px; height: 16px;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        // Enhanced utility functions
        function safeToDate(dateValue) {
            if (!dateValue) return null;
            
            if (dateValue instanceof Date) {
                return dateValue;
            }
            
            if (dateValue && typeof dateValue.toDate === 'function') {
                return dateValue.toDate();
            }
            
            if (typeof dateValue === 'string') {
                const parsed = new Date(dateValue);
                return isNaN(parsed.getTime()) ? null : parsed;
            }
            
            if (typeof dateValue === 'number') {
                return new Date(dateValue);
            }
            
            if (dateValue && typeof dateValue.seconds === 'number') {
                return new Date(dateValue.seconds * 1000);
            }
            
            return null;
        }
        
        function clearAllFilters() {
            // Reset all filter inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('factoryFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('typeFilter').value = '';
            
            // Apply filters to refresh the display
            applyFilters();
            
            showNotification('All filters cleared', 'success');
        }
        
        function selectAllDocuments() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : true;
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-doc-id]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const docId = checkbox.getAttribute('data-doc-id');
                if (docId) {
                    if (isChecked) {
                        selectedDocuments.add(docId);
                    } else {
                        selectedDocuments.delete(docId);
                    }
                }
            });
            
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            if (!bulkActions) return;
            
            if (selectedDocuments.size > 0) {
                bulkActions.style.display = 'flex';
                bulkActions.innerHTML = `
                    <span>${selectedDocuments.size} document(s) selected</span>
                    <button class="btn btn-secondary" onclick="bulkDownload()">
                        <i data-lucide="download"></i> Download
                    </button>
                    ${canWrite ? `
                    <button class=\"btn btn-secondary\" onclick=\"bulkDelete()\">
                        <i data-lucide=\"trash-2\"></i> Delete
                    </button>` : ''}
                `;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        function bulkDownload() {
            if (selectedDocuments.size === 0) {
                showNotification('No documents selected', 'warning');
                return;
            }
            
            selectedDocuments.forEach(docId => {
                downloadDocument(docId);
            });
            
            showNotification(`Downloading ${selectedDocuments.size} documents...`, 'success');
        }
        
        async function bulkDelete() {
            if (!canWrite) { showNotification('Insufficient permissions', 'error'); return; }
            if (selectedDocuments.size === 0) { showNotification('No documents selected', 'warning'); return; }
            const count = selectedDocuments.size;
            if (!confirm(`Are you sure you want to delete ${count} document(s)? This action cannot be undone.`)) return;
            try {
                const ids = Array.from(selectedDocuments);
                await Promise.all(ids.map(async (docId) => {
                    const doc = allDocuments.find(d => d.id === docId);
                    const docRef = doc(db, 'documents', docId);
                    await deleteDoc(docRef);
                    if (doc && doc.fileName) {
                        try { await firebase.storage().ref(doc.fileName).delete(); } catch (e) { /* ignore */ }
                    }
                    allDocuments = allDocuments.filter(d => d.id !== docId);
                }));
                applyFilters();
                updateStats();
                showNotification(`${count} document(s) deleted successfully`, 'success');
            } catch (e) {
                console.error('Bulk delete error', e);
                showNotification('Failed to delete some documents', 'error');
            } finally {
                selectedDocuments.clear();
                updateBulkActions();
            }
        }
        
        async function deleteDocument(docId) {
            if (!canWrite) { showNotification('Insufficient permissions', 'error'); return; }
            if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) return;
            const doc = allDocuments.find(d => d.id === docId);
            if (!doc) { showError('Document not found'); return; }
            try {
                const docRef = doc(db, 'documents', docId);
                await deleteDoc(docRef);
                if (doc.fileName) {
                    try { await firebase.storage().ref(doc.fileName).delete(); } catch (e) { /* ignore */ }
                }
                allDocuments = allDocuments.filter(d => d.id !== docId);
                applyFilters();
                updateStats();
                showNotification('Document deleted successfully', 'success');
            } catch (e) {
                console.error('Delete error', e);
                showNotification('Failed to delete document', 'error');
            }
        }
        
        function toggleDocumentSelection(docId) {
            if (selectedDocuments.has(docId)) {
                selectedDocuments.delete(docId);
            } else {
                selectedDocuments.add(docId);
            }
            
            updateBulkActions();
        }
        
        function setView(view) {
            currentView = view;
            
            // Update view toggle buttons
            document.querySelectorAll('.view-option').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="setView('${view}')"]`).classList.add('active');
            
            // Update display
            updateDocumentsDisplay();
        }
        
        function viewDocument(docId) {
            const doc = allDocuments.find(d => d.id === docId);
            if (doc && doc.downloadURL) {
                window.open(doc.downloadURL, '_blank');
            }
        }
        
        function downloadDocument(docId) {
            const doc = allDocuments.find(d => d.id === docId);
            if (doc && doc.downloadURL) {
                const a = document.createElement('a');
                a.href = doc.downloadURL;
                a.download = doc.originalName || 'document';
                a.click();
            }
        }
        
        function shareDocument(docId) {
            const doc = allDocuments.find(d => d.id === docId);
            if (doc && doc.downloadURL) {
                if (navigator.share) {
                    navigator.share({
                        title: doc.title || doc.originalName,
                        text: `Document: ${doc.title || doc.originalName}`,
                        url: doc.downloadURL
                    });
                } else {
                    navigator.clipboard.writeText(doc.downloadURL).then(() => {
                        alert('Document URL copied to clipboard!');
                    });
                }
            }
        }
        
        function editDocument(docId) {
            // Redirect to upload page with edit mode
            window.location.href = `upload.html?edit=${docId}`;
        }
        
        function viewVersions(docId) {
            window.location.href = `document-versioning.html?id=${docId}`;
        }
        
        function exportDocuments() {
            try {
                // Get filtered documents
                const documentsToExport = filteredDocuments.length > 0 ? filteredDocuments : allDocuments;
                
                if (documentsToExport.length === 0) {
                    showNotification('No documents to export', 'warning');
                    return;
                }
                
                // Create CSV content
                const csvContent = createCSVContent(documentsToExport);
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `documents_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`Exported ${documentsToExport.length} documents successfully`, 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export documents', 'error');
            }
        }
        
        function createCSVContent(documents) {
            const headers = [
                'Title',
                'Category',
                'Factory',
                'Status',
                'Upload Date',
                'Expiration Date',
                'File Size',
                'File Type',
                'Document Number',
                'Issuing Authority',
                'Description'
            ];
            
            const csvRows = [headers.join(',')];
            
            documents.forEach(doc => {
                const row = [
                    `"${doc.title || doc.originalName || ''}"`,
                    `"${doc.categoryName || ''}"`,
                    `"${doc.factoryId || ''}"`,
                    `"${formatStatus(getDocumentStatus(doc))}"`,
                    `"${formatDate(doc.uploadedAt)}"`,
                    `"${formatDate(doc.expirationDate)}"`,
                    `"${formatFileSize(doc.fileSize)}"`,
                    `"${doc.fileType || ''}"`,
                    `"${doc.documentNumber || ''}"`,
                    `"${doc.issuingAuthority || ''}"`,
                    `"${doc.description || ''}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }
        
        function importDocuments() {
            // Create file input for CSV import
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const documents = parseCSVContent(text);
                    
                    if (documents.length === 0) {
                        showNotification('No valid documents found in CSV file', 'warning');
                        return;
                    }
                    
                    // Show import preview
                    showImportPreview(documents);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Failed to read CSV file', 'error');
                }
                
                // Clean up
                document.body.removeChild(fileInput);
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        function parseCSVContent(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const documents = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const doc = {};
                
                headers.forEach((header, index) => {
                    if (values[index]) {
                        doc[header.toLowerCase().replace(/\s+/g, '')] = values[index];
                    }
                });
                
                if (doc.title) {
                    documents.push(doc);
                }
            }
            
            return documents;
        }
        
        function showImportPreview(documents) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Import Preview (${documents.length} documents)</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="import-preview">
                            <table class="documents-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Factory</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${documents.slice(0, 10).map(doc => `
                                        <tr>
                                            <td>${doc.title || 'N/A'}</td>
                                            <td>${doc.category || 'N/A'}</td>
                                            <td>${doc.factory || 'N/A'}</td>
                                            <td>${doc.status || 'Active'}</td>
                                        </tr>
                                    `).join('')}
                                    ${documents.length > 10 ? `<tr><td colspan="4">... and ${documents.length - 10} more documents</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                        <div class="import-actions">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmImport(${JSON.stringify(documents).replace(/"/g, '&quot;')})">Import Documents</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        function confirmImport(documents) {
            // This would typically save the documents to the database
            // For now, we'll just show a success message
            showNotification(`Successfully imported ${documents.length} documents`, 'success');
            document.querySelector('.modal-overlay').remove();
        }
        
        // Utility functions
        function getDocumentStatus(doc) {
            if (!doc.expirationDate) return 'active';
            
            const now = new Date();
            
            // Handle Firestore Timestamp objects
            let expirationDate = doc.expirationDate;
            if (expirationDate && typeof expirationDate.toDate === 'function') {
                expirationDate = expirationDate.toDate();
            } else if (typeof expirationDate === 'string') {
                expirationDate = new Date(expirationDate);
            } else if (typeof expirationDate === 'number') {
                expirationDate = new Date(expirationDate);
            }
            
            // Ensure we have a valid Date object
            if (!(expirationDate instanceof Date) || isNaN(expirationDate.getTime())) {
                return 'active';
            }
            
            const daysUntilExpiration = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiration <= 0) return 'expired';
            if (daysUntilExpiration <= 30) return 'expiring';
            return 'active';
        }
        
        function getDocumentIcon(fileType) {
            if (fileType?.includes('pdf')) {
                return '<i data-lucide="file-text"></i>';
            } else if (fileType?.includes('word') || fileType?.includes('document')) {
                return '<i data-lucide="file-text"></i>';
            } else if (fileType?.includes('image')) {
                return '<i data-lucide="image"></i>';
            } else {
                return '<i data-lucide="file"></i>';
            }
        }
        
        function getStatusIcon(status) {
            const icons = {
                active: '<i data-lucide="check-circle" style="width: 12px; height: 12px;"></i>',
                expiring: '<i data-lucide="clock" style="width: 12px; height: 12px;"></i>',
                expired: '<i data-lucide="x-circle" style="width: 12px; height: 12px;"></i>'
            };
            return icons[status] || '';
        }
        
        function formatStatus(status) {
            const statusMap = {
                active: 'Active',
                expiring: 'Expiring Soon',
                expired: 'Expired'
            };
            return statusMap[status] || 'Unknown';
        }
        
        function formatDate(date) {
            if (!date) return 'Not set';
            
            // Handle Firestore Timestamp objects
            if (date && typeof date.toDate === 'function') {
                date = date.toDate();
            }
            
            // Handle string dates
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            // Handle numeric timestamps
            if (typeof date === 'number') {
                date = new Date(date);
            }
            
            // Ensure we have a valid Date object
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                return 'Invalid date';
            }
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Cleanup real-time listeners
                realTimeListeners.forEach(unsubscribe => unsubscribe());
                realTimeListeners = [];
                
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                    window.location.href = 'login.html';
                });
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            realTimeListeners.forEach(unsubscribe => unsubscribe());
        });
        
        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
        
        // AI Analysis Functions
        async function analyzeDocumentWithAI(documentId) {
            if (!window.openAI || !window.openAI.isConfigured) {
                showAINotification('Please configure OpenAI API key first. Go to OpenAI Configuration page.', 'error');
                return;
            }
            
            try {
                // Show loading state
                showAINotification('Analyzing document with AI...', 'info');
                
                // Get document data
                const docRef = doc(db, 'documents', documentId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    showAINotification('Document not found', 'error');
                    return;
                }
                
                const documentData = docSnap.data();
                
                // For text-based documents, we can analyze the content
                // For other types, we'll analyze the metadata
                let documentText = '';
                
                if (documentData.content) {
                    documentText = documentData.content;
                } else if (documentData.description) {
                    documentText = documentData.description;
                } else {
                    // Create a text representation of the document metadata
                    documentText = `
                        Document Title: ${documentData.title || documentData.originalName || 'Untitled'}
                        Document Type: ${documentData.fileType || 'Unknown'}
                        Category: ${documentData.categoryName || 'Uncategorized'}
                        Factory: ${documentData.factoryId || 'Unknown Factory'}
                        Upload Date: ${formatDate(documentData.uploadedAt)}
                        File Size: ${formatFileSize(documentData.fileSize)}
                        Status: ${getDocumentStatus(documentData)}
                    `;
                }
                
                // Analyze with AI
                const analysis = await window.openAI.analyzeDocument(documentText, 'compliance');
                
                // Display results
                displayAIAnalysisResults(analysis, documentData);
                
                showAINotification('AI analysis completed successfully!', 'success');
                
            } catch (error) {
                console.error('AI analysis failed:', error);
                showAINotification('AI analysis failed: ' + error.message, 'error');
            }
        }
        
        function displayAIAnalysisResults(analysis, documentData) {
            // Create modal for AI analysis results
            const modal = document.createElement('div');
            modal.className = 'ai-analysis-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>🤖 AI Analysis Results</h3>
                        <button class="close-btn" onclick="this.closest('.ai-analysis-modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="document-info">
                            <h4>${documentData.title || documentData.originalName || 'Untitled Document'}</h4>
                            <p class="document-meta">${documentData.fileType} • ${formatFileSize(documentData.fileSize)} • ${formatDate(documentData.uploadedAt)}</p>
                        </div>
                        
                        <div class="analysis-results">
                            <div class="analysis-section">
                                <h5>📊 Compliance Status</h5>
                                <div class="status-badge ${analysis.complianceStatus?.toLowerCase() || 'unknown'}">
                                    ${analysis.complianceStatus || 'Unknown'}
                                </div>
                            </div>
                            
                            <div class="analysis-section">
                                <h5>⚠️ Risk Level</h5>
                                <div class="risk-badge ${analysis.riskLevel?.toLowerCase() || 'unknown'}">
                                    ${analysis.riskLevel || 'Unknown'}
                                </div>
                            </div>
                            
                            <div class="analysis-section">
                                <h5>📈 Compliance Score</h5>
                                <div class="score-display">
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${analysis.complianceScore || 0}%"></div>
                                    </div>
                                    <span class="score-text">${analysis.complianceScore || 0}/100</span>
                                </div>
                            </div>
                            
                            ${analysis.issues ? `
                                <div class="analysis-section">
                                    <h5>🚨 Identified Issues</h5>
                                    <div class="issues-list">
                                        ${analysis.issues}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${analysis.recommendations ? `
                                <div class="analysis-section">
                                    <h5>💡 Recommendations</h5>
                                    <div class="recommendations-list">
                                        ${analysis.recommendations}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${analysis.priorityActions ? `
                                <div class="analysis-section">
                                    <h5>⚡ Priority Actions</h5>
                                    <div class="priority-actions">
                                        ${analysis.priorityActions}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="this.closest('.ai-analysis-modal').remove()">Close</button>
                            <button class="btn btn-primary" onclick="exportAnalysisResults('${documentData.id}')">Export Results</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function showAINotification(message, type) {
            if (window.openAI && window.openAI.showNotification) {
                window.openAI.showNotification(message, type);
            } else {
                // Fallback notification
                alert(message);
            }
        }
        
        async function exportAnalysisResults(documentId) {
            try {
                // Get the analysis results from the modal
                const modal = document.querySelector('.ai-analysis-modal');
                if (!modal) return;
                
                const analysisData = {
                    documentId: documentId,
                    timestamp: new Date().toISOString(),
                    analysis: {
                        complianceStatus: modal.querySelector('.status-badge')?.textContent,
                        riskLevel: modal.querySelector('.risk-badge')?.textContent,
                        complianceScore: modal.querySelector('.score-text')?.textContent,
                        issues: modal.querySelector('.issues-list')?.textContent,
                        recommendations: modal.querySelector('.recommendations-list')?.textContent,
                        priorityActions: modal.querySelector('.priority-actions')?.textContent
                    }
                };
                
                // Export as JSON
                const dataStr = JSON.stringify(analysisData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `ai-analysis-${documentId}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                showAINotification('Analysis results exported successfully!', 'success');
                
            } catch (error) {
                console.error('Export failed:', error);
                showAINotification('Export failed: ' + error.message, 'error');
            }
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
        
        // Debug function to test document management
        function testDocumentManagement() {
            console.log('🧪 Testing Document Management System...');
            console.log('📊 Current state:');
            console.log('- All documents:', allDocuments.length);
            console.log('- Filtered documents:', filteredDocuments.length);
            console.log('- Factories:', factories.length);
            console.log('- Current user role:', currentUserRole);
            console.log('- Current user factory ID:', currentUserFactoryId);
            console.log('- Can write:', canWrite);
            
            // Test sample data loading
            if (allDocuments.length === 0) {
                console.log('📋 Loading sample documents...');
                loadSampleDocuments();
                updateDocumentsDisplay();
                updateStats();
            }
            
            console.log('✅ Document Management test completed');
        }
        
        function showError(message) {
            alert('Error: ' + message);
        }
    })();
    </script>
</body>
</html>
